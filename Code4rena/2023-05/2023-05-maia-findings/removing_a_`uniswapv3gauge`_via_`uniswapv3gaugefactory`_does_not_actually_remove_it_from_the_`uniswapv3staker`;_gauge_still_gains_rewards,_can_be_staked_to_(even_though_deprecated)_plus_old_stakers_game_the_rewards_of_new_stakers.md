## Tags

- bug
- 2 (Med Risk)
- primary issue
- satisfactory
- selected for report
- sponsor confirmed
- M-35

# [Removing a `UniswapV3Gauge` via `UniswapV3GaugeFactory` does not actually remove it from the `UniswapV3Staker`; Gauge still gains rewards, can be staked to (even though deprecated) plus old stakers game the rewards of new stakers](https://github.com/code-423n4/2023-05-maia-findings/issues/277) 

# Lines of code

https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L340-L348
https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L465-L473
https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L475-L519
https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/BaseV2GaugeFactory.sol#L125-L137


# Vulnerability details

## Impact

Gauge factories have a [`BaseV2GaugeFactory::removeGauge`](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/BaseV2GaugeFactory.sol#L130-L137) that removes the indicate gauge and marks it as deprecated for the corresponding [`bHermesGauges` and `bHermesBoost`](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/BaseV2GaugeManager.sol#L100-L103) token contracts.

However, removing a `UniswapV3Gauge` with `UniswapV3GaugeFactory` does not actually remove it from the `UniswapV3Staker`; Gauge still remains and existing users that staked still gain the exact same benefits from it.
What is worse that staking to the gauge can still happen and any new users that stakes cannot receive a share of the generated fees (plus boost), as it is impossible to vote for the deprecated gauge.

### Issue detailed explanation

When a `UniswapV3Gauge` is created via `UniswapV3GaugeFactory` it is also attached to a `UniswapV3Staker` via the [`BaseV2GaugeFactory::afterCreateGauge`](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/BaseV2GaugeFactory.sol#L122-L125) callback [implementation](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/UniswapV3GaugeFactory.sol#L87-L91):

```Solidity
    /// @notice Adds Gauge to UniswapV3Staker
    /// @dev Updates the UniswapV3 staker with bribe and minimum width information
    function afterCreateGauge(address strategy, bytes memory) internal override {
        uniswapV3Staker.updateGauges(IUniswapV3Pool(strategy));
    }
```

However there is no `afterCreateRemoved` mechanism implemented in `BaseV2GaugeFactory`, as such, the `UniswapV3Staker` contract is never updated about the removed gauge.
This creates a situation in which existing users/stakes benefit while new stakes lose out on bribes, gaming the system.

This is because: 

- new users can stake to the deprecated gauge, as there is no mechanism to check if the gauge they are staking to is active or not (similar to how [`UniswapV3Staker::updateGauges` checks](https://github.com/code-423n4/2023-05-maia/blob/54a45beb1428d85999da3f721f923cbf36ee3d35/src/uni-v3-staker/UniswapV3Staker.sol#L526-L529))

```Solidity
    function updateGauges(IUniswapV3Pool uniswapV3Pool) external {
        address uniswapV3Gauge = address(uniswapV3GaugeFactory.strategyGauges(address(uniswapV3Pool)));


        if (uniswapV3Gauge == address(0)) revert InvalidGauge();
```

- **but** new users that stake to the deprecated gauge do not receive a portion of fees that are generated and sent to the bribe deposit. Although users that have staked to the _now_ deprecated gauge **beforehand** still gain the fees generated by the staked positions. 

This happens because when gauge removal happened in [BaseV2GaugeManager::removeGauge](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/BaseV2GaugeManager.sol#L100-L103) the indicated gauge is marked as deprecated ([bHermesGauges::ERC20Gauges::_removeGauge](https://github.com/code-423n4/2023-05-maia/blob/main/src/erc-20/ERC20Gauges.sol#L435). Users that have already voted to the deprecated gauge still get the bribe rewards when `BaseV2Gauge::accrueBribes` is called. 

Rewards flows is:

- [BaseV2Gauge::accrueBribes](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/BaseV2Gauge.sol#L111-L121)
    - [FlywheelCore::accrue](https://github.com/code-423n4/2023-05-maia/blob/main/src/rewards/base/FlywheelCore.sol#L69-L72)
        - [FlywheelCore::_accrue](https://github.com/code-423n4/2023-05-maia/blob/main/src/rewards/base/FlywheelCore.sol#L74-L81)
            - [FlywheelCore::accrueUser](https://github.com/code-423n4/2023-05-maia/blob/main/src/rewards/base/FlywheelCore.sol#L196-L198) (influences reward calculation)
                - [FlywheelBoosterGaugeWeight::boostedBalanceOf](https://github.com/code-423n4/2023-05-maia/blob/main/src/rewards/booster/FlywheelBoosterGaugeWeight.sol#L58-L61)
                    - [bHermesGauges::ERC20Gauges::getUserGaugeWeight](https://github.com/code-423n4/2023-05-maia/blob/main/src/erc-20/interfaces/IERC20Gauges.sol#L62-L65)
                        - and `ERC20Gauges::getUserGaugeWeight` is only [increasable if the gauge is not deprecated](https://github.com/code-423n4/2023-05-maia/blob/main/src/erc-20/ERC20Gauges.sol#L203)


To be noted that the action of _unstaking_ (calling [UniswapV3Staker::_unstakeToken](https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L377-L390)) sends rewards to the gauge bribe deposit:
```Solidity
            // scope for bribeAddress, avoids stack too deep errors
            address bribeAddress = bribeDepots[key.pool];


            if (bribeAddress != address(0)) {
                nonfungiblePositionManager.collect(
                    INonfungiblePositionManager.CollectParams({
                        tokenId: tokenId,
                        recipient: bribeAddress,
                        amount0Max: type(uint128).max,
                        amount1Max: type(uint128).max
                    })
                );
            }
        }
```

from where it is then transferred to those that already delegated to the (now deprecated) gauge following the already mentioned execution flow.


Note, deprecated gauges [still have the boosting bonus associated with `bHermesBoost`](https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L401-L424) where the same issue as above appears, already existing users get the boost, new users cannot. 

```Solidity
        // ...
        
        // get boost amount and total supply
        (boostAmount, boostTotalSupply) = hermesGaugeBoost.getUserGaugeBoost(owner, address(gauge));
        
        // ...

        secondsInsideX128 = RewardMath.computeBoostedSecondsInsideX128(
            // ...
            uint128(boostAmount),
            uint128(boostTotalSupply),
            // ...

        );

        // ...

        uint256 reward = RewardMath.computeBoostedRewardAmount(
            // ...
            secondsInsideX128,
            // ...
        );

        }
```

## Proof of Concept

A step by step execution flow was shown above in **Issue detailed explanation**

Lack of active gauge check can be observed in any of the staking flow functions:
- [restakeToken](https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L340-L348)
- [stakeToken](https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L465-L473)
- [_stakeToken](https://github.com/code-423n4/2023-05-maia/blob/main/src/uni-v3-staker/UniswapV3Staker.sol#L475-L519) (called by the above 2)

Also no [`BaseV2GaugeFactory::afterCreateRemoved`](https://github.com/code-423n4/2023-05-maia/blob/main/src/gauges/factories/BaseV2GaugeFactory.sol#L125-L137) type callback existing

A theoretical POC would by as:
- a `UniswapV3Gauge` is created via `UniswapV3GaugeFactory` (it is also automatically attached to the existing `UniswapV3Staker`)
- users vote for it via `bHermesGauges`
- team decides to remove the existing `UniswapV3Gauge` for a newer version
- team calls `BaseV2GaugeFactory::removeGauge` that does not remove the gauge from the `UniswapV3Staker` while also deprecating it in `bHermesGauges`
- the now deprecated and faulty removed `UniswapV3Gauge` still receives fees from the `UniswapV3Staker`
- new users stake to the removed `UniswapV3Gauge` but will not receive any bribe rewards creating a situation where the first depositors gain the later ones

## Tools Used

Manual analysis and, **the most important factor**: a very good, active and helping project team!

## Recommended Mitigation Steps

As the system is complex we must take into consideration a few observations:

- we cannot remove the gauge from `UniswapV3Staker` because already existing incentives would become bricked and worthless
- removing a gauge completely from the `UniswapV3Staker` means loosing potential rewards deposited by users
    - a `UniswapV3Staker` without the `bHermesGauges` mechanism is similar to a normal `UniswapV3Staker` so it does still work has some incentive
- leaving the gauge open to be staked and added incentives would allow old stakers to pray on new stakes and new stakers will not receive any fees generated by the staked positions
- refunding potential emissions (rewards) deposited by users (or protocols) adds storage overhead
- a `BaseV2GaugeFactory::afterCreateRemoved` mechanism is required regardless for any future gauge that needs post remove operations
- deprecated gauges still have the boosting bonus associated with `bHermesBoost` where the same issue as above appears, already existing users get the boost, new users cannot

A possible solution can be a mix of the above:
1. create a `BaseV2GaugeFactory::afterCreateRemoved` mechanism
2. add a function `UniswapV3GaugeFactory::afterCreateRemoved` that overrides the above that calls `UniswapV3Staker::updateBribeDepot`
3. in `UniswapV3Staker::updateBribeDepot` check if the strategy associated with the `IUniswapV3Pool` is active and if not, then set the bribeDepot (`bribeDepots[uniswapV3Pool]`) of that pool's gauge to the zero address so that no new rewards are sent to the deprecated gauge

The above is a minimum suggested regardless. Extra:

3. add a check for  `UniswapV3Staker::_stakeToken` if the gauge is active or not and revert; i.e. do not allow any further staking into inactive gauges
4. Consider decreasing the gain value of `bHermesBoost` if the gauge is deprecated in `_unstakeToken`. Some more consideration should be taken if implementing this as any reward bonuses that were not collected before the removal/deprecation will also be lost (that in itself is an issue that must not happen).


## Assessed type

Other